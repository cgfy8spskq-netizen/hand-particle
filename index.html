<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Neon Hand Particle</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
html,body{
  margin:0;
  overflow:hidden;
  background:radial-gradient(circle at center,#12001f,#000);
}
#hint{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  font-size:12px;
  opacity:.7;
}
video{display:none;}
</style>
</head>
<body>
<div id="hint">✋ Đưa tay trước camera</div>
<video id="video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= SCENE ================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,1000);
camera.position.z=120;

const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ================= PARTICLES ================= */
const COUNT=2000;
const pos=new Float32Array(COUNT*3);
const vel=[];
const colors=new Float32Array(COUNT*3);

const color=new THREE.Color();

for(let i=0;i<COUNT;i++){
  pos[i*3]=(Math.random()-0.5)*50;
  pos[i*3+1]=(Math.random()-0.5)*50;
  pos[i*3+2]=(Math.random()-0.5)*50;
  vel.push(new THREE.Vector3());
  color.setHSL(Math.random(),1,.6);
  colors.set([color.r,color.g,color.b],i*3);
}

const geo=new THREE.BufferGeometry();
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
geo.setAttribute('color',new THREE.BufferAttribute(colors,3));

const mat=new THREE.PointsMaterial({
  size:1,
  vertexColors:true,
  transparent:true,
  blending:THREE.AdditiveBlending,
  opacity:.9
});

const pts=new THREE.Points(geo,mat);
scene.add(pts);

/* ================= SHAPES ================= */
let shape=0, targetScale=1, flow=new THREE.Vector3();

function heart(i){
  const t=i/COUNT*Math.PI*2;
  return new THREE.Vector3(
    16*Math.pow(Math.sin(t),3),
    13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t),
    (Math.random()-.5)*8
  ).multiplyScalar(1.4);
}

function flower(i){
  const t=i/COUNT*Math.PI*8;
  const r=20+6*Math.sin(6*t);
  return new THREE.Vector3(
    Math.cos(t)*r,
    Math.sin(t)*r,
    (Math.random()-.5)*8
  );
}

function saturn(i){
  const t=i/COUNT*Math.PI*2;
  const r=i%2?25:15;
  return new THREE.Vector3(
    Math.cos(t)*r,
    Math.sin(t)*r,
    (i%2?2:-2)
  );
}

function firework(){
  for(let i=0;i<COUNT;i++){
    vel[i].copy(
      new THREE.Vector3(
        Math.random()-.5,
        Math.random()-.5,
        Math.random()-.5
      ).normalize().multiplyScalar(4)
    );
  }
}

function targetPos(i){
  if(shape===0) return heart(i);
  if(shape===1) return flower(i);
  if(shape===2) return saturn(i);
  return new THREE.Vector3();
}

/* ================= HAND TRACKING ================= */
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:.5,
  minTrackingConfidence:.5
});

let lastSwitch=0;

hands.onResults(r=>{
  if(!r.multiHandLandmarks){
    targetScale=1;
    flow.multiplyScalar(.9);
    return;
  }

  const h=r.multiHandLandmarks[0];
  const w=h[0], i=h[8];
  const palm=Math.hypot(i.x-w.x,i.y-w.y);

  targetScale=THREE.MathUtils.clamp(palm*4,.7,1.6);
  flow.lerp(new THREE.Vector3(
    (i.x-.5)*6,
    -(i.y-.5)*6,
    0
  ),.2);

  if(r.multiHandLandmarks.length===2 && Date.now()-lastSwitch>1200){
    shape=(shape+1)%4;
    lastSwitch=Date.now();
    if(shape===3) firework();
  }
});

new Camera(document.getElementById('video'),{
  onFrame:async()=>hands.send({image:video}),
  width:480,height:360
}).start();

/* ================= LOOP ================= */
function animate(){
  requestAnimationFrame(animate);
  const p=geo.attributes.position.array;

  for(let i=0;i<COUNT;i++){
    const idx=i*3;
    const tp=targetPos(i).multiplyScalar(targetScale);

    vel[i].x+=(tp.x-p[idx])*.002+flow.x*.01;
    vel[i].y+=(tp.y-p[idx+1])*.002+flow.y*.01;
    vel[i].z+=(tp.z-p[idx+2])*.002;

    vel[i].multiplyScalar(.92);

    p[idx]+=vel[i].x;
    p[idx+1]+=vel[i].y;
    p[idx+2]+=vel[i].z;
  }

  geo.attributes.position.needsUpdate=true;
  pts.rotation.y+=.002;
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

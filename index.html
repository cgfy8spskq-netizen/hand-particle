<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Heart Particle Gesture</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
html,body{
  margin:0; padding:0; overflow:hidden;
  background:radial-gradient(circle,#2b0f1f,#050008);
}
#hint{
  position:fixed;
  bottom:14px; left:50%;
  transform:translateX(-50%);
  font-size:12px;
  color:#fff; opacity:.7;
}
video{display:none;}
</style>
</head>
<body>

<div id="hint">✋ Đưa tay trước camera</div>
<video id="video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= THREE ================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,1000);
camera.position.z=120;

const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ================= HEART PARTICLES ================= */
const COUNT=1600;
let scale=1,targetScale=1,beat=0,spark=0;
let flowX=0,flowY=0;

const basePos=[],pos=new Float32Array(COUNT*3);

function heart(t){
  return {
    x:16*Math.sin(t)**3,
    y:13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)
  };
}

for(let i=0;i<COUNT;i++){
  const t=Math.random()*Math.PI*2;
  const h=heart(t);
  const z=(Math.random()-.5)*6;
  const v=new THREE.Vector3(h.x,h.y,z).normalize();
  basePos.push(v);
  pos.set([v.x*25,v.y*25,v.z*25],i*3);
}

const geo=new THREE.BufferGeometry();
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));

const mat=new THREE.PointsMaterial({
  color:0xff5c8a,
  size:1,
  transparent:true,
  opacity:.9
});

const pts=new THREE.Points(geo,mat);
scene.add(pts);

/* ================= HAND TRACKING (DỄ) ================= */
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:.5,
  minTrackingConfidence:.5
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks||r.multiHandLandmarks.length===0){
    targetScale=1;
    flowX*=.9; flowY*=.9;
    return;
  }

  const hand=r.multiHandLandmarks[0];
  const wrist=hand[0];
  const indexTip=hand[8];
  const indexBase=hand[6];

  const palm=Math.hypot(indexTip.x-wrist.x,indexTip.y-wrist.y);
  targetScale=THREE.MathUtils.clamp(palm*4,.8,1.6);

  if(palm<.12) beat=1;
  if(palm>.18) spark=1;

  // 1 ngón → hướng
  const dx=indexTip.x-indexBase.x;
  const dy=indexTip.y-indexBase.y;
  flowX+=dx*0.5;
  flowY+=-dy*0.5;

  if(r.multiHandLandmarks.length===2) spark=1.5;
});

new Camera(document.getElementById('video'),{
  onFrame:async()=>{await hands.send({image:video});},
  width:480,height:360
}).start();

/* ================= LOOP ================= */
let t=0;
function animate(){
  requestAnimationFrame(animate);
  t+=0.02;

  scale+=(targetScale-scale)*0.08;
  beat*=.9; spark*=.9;
  flowX*=.95; flowY*=.95;

  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const v=basePos[i];
    let r=25*scale;

    if(beat) r+=Math.sin(t*20+i)*2;
    if(spark) r+=Math.sin(t*5+i)*3;

    p[i*3]=v.x*r+flowX*10;
    p[i*3+1]=v.y*r+flowY*10;
    p[i*3+2]=v.z*r;
  }
  geo.attributes.position.needsUpdate=true;

  mat.color.offsetHSL(0.001,0,0);
  pts.rotation.y+=0.002;

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Particles - Advanced Gestures</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; background: rgba(255,255,255,0.1); 
               backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; z-index: 100; border: 1px solid rgba(255,255,255,0.2); }
        #video-preview { position: absolute; bottom: 20px; right: 20px; width: 150px; border: 2px solid #fff; border-radius: 12px; transform: scaleX(-1); opacity: 0.7; }
        .gesture-hint { font-size: 13px; color: #00ffff; margin-top: 5px; }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h2 style="margin:0 0 10px 0;">Magic Particles</h2>
        <input type="color" id="particleColor" value="#00ffff"> <span>Ch·ªânh m√†u n·ªÅn</span>
        <div id="status" style="font-weight: bold; color: #ffeb3b; margin: 10px 0;">ƒêang ƒë·ª£i tay...</div>
        <div class="gesture-hint">‚òùÔ∏è Ch·ªâ tay: H√∫t h·∫°t theo ng√≥n</div>
        <div class="gesture-hint">‚úä N·∫Øm tay: H·ªë ƒëen & N·ªï tung</div>
        <div class="gesture-hint">‚úåÔ∏è Ch·ªØ V: Ch·∫ø ƒë·ªô C·∫ßu v·ªìng</div>
    </div>
    
    <video id="video-preview" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let scene, camera, renderer, particles, clock;
        let mode = 'idle'; // idle, attract, fist, rainbow
        let targetPoint = new THREE.Vector3();
        const PARTICLE_COUNT = 8000;

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 3000);
            camera.position.z = 800;
            clock = new THREE.Clock();

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(PARTICLE_COUNT * 3);
            const vel = new Float32Array(PARTICLE_COUNT * 3);
            const colors = new Float32Array(PARTICLE_COUNT * 3);

            for(let i=0; i<PARTICLE_COUNT*3; i++) {
                pos[i] = (Math.random() - 0.5) * 1500;
                vel[i] = (Math.random() - 0.5) * 2;
                colors[i] = Math.random();
            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('velocity', new THREE.BufferAttribute(vel, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const mat = new THREE.PointsMaterial({
                size: 3,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6 });

        hands.onResults((res) => {
            const status = document.getElementById('status');
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const marks = res.multiHandLandmarks[0];
                
                // 1. Ki·ªÉm tra C·ª≠ ch·ªâ
                const isIndexUp = marks[8].y < marks[6].y;
                const isMiddleUp = marks[12].y < marks[10].y;
                const isFist = marks[8].y > marks[6].y && marks[12].y > marks[10].y;

                if (isFist) {
                    mode = 'fist';
                    status.innerText = "‚úä BLACK HOLE MODE";
                } else if (isIndexUp && isMiddleUp) {
                    mode = 'rainbow';
                    status.innerText = "‚úåÔ∏è DISCO MODE";
                } else if (isIndexUp) {
                    mode = 'attract';
                    status.innerText = "‚òùÔ∏è ATTRACT MODE";
                    // Chuy·ªÉn t·ªça ƒë·ªô ng√≥n tay sang kh√¥ng gian 3D
                    targetPoint.x = (0.5 - marks[8].x) * 1500;
                    targetPoint.y = (0.5 - marks[8].y) * 1000;
                } else {
                    mode = 'idle';
                    status.innerText = "üñê ƒêANG ƒê·ª¢I...";
                }
            }
        });

        const cam = new Camera(document.getElementById('video-preview'), {
            onFrame: async () => { await hands.send({image: document.getElementById('video-preview')}); },
            width: 640, height: 480
        });
        cam.start();

        function animate() {
            requestAnimationFrame(animate);
            const positions = particles.geometry.attributes.position.array;
            const velocities = particles.geometry.attributes.velocity.array;
            const colors = particles.geometry.attributes.color.array;
            const time = clock.getElapsedTime();

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;

                if (mode === 'attract') {
                    // H√∫t v·ªÅ ph√≠a ng√≥n tay
                    velocities[i3] += (targetPoint.x - positions[i3]) * 0.002;
                    velocities[i3+1] += (targetPoint.y - positions[i3+1]) * 0.002;
                } else if (mode === 'fist') {
                    // H·ªë ƒëen t·∫°i t√¢m
                    velocities[i3] += (0 - positions[i3]) * 0.02;
                    velocities[i3+1] += (0 - positions[i3+1]) * 0.02;
                } else if (mode === 'rainbow') {
                    // Nh·∫£y m√∫a ng·∫´u nhi√™n
                    velocities[i3] += Math.sin(time + i) * 0.5;
                    velocities[i3+1] += Math.cos(time + i) * 0.5;
                    // ƒê·ªïi m√†u
                    colors[i3] = Math.sin(time * 2);
                    colors[i3+1] = Math.cos(time * 3);
                }

                // C·∫≠p nh·∫≠t v·ªã tr√≠ & Ma s√°t (Friction)
                positions[i3] += velocities[i3];
                positions[i3+1] += velocities[i3+1];
                velocities[i3] *= 0.95;
                velocities[i3+1] *= 0.95;

                // Gi·ªØ h·∫°t trong m√†n h√¨nh
                if(Math.abs(positions[i3]) > 1000) positions[i3] *= -0.9;
                if(Math.abs(positions[i3+1]) > 1000) positions[i3+1] *= -0.9;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            if(mode === 'rainbow') particles.geometry.attributes.color.needsUpdate = true;
            
            particles.rotation.y += 0.001;
            renderer.render(scene, camera);
        }

        initThree();
        animate();

        // X·ª≠ l√Ω ƒë·ªïi m√†u n·ªÅn
        document.getElementById('particleColor').addEventListener('input', (e) => {
            renderer.setClearColor(e.target.value);
        });
    </script>
</body>
</html>
